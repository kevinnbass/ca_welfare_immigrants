name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff linter
        run: ruff check .

      - name: Run Ruff formatter check
        run: ruff format --check .

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Debug info
        run: |
          python --version
          pip list
          python -c "import pytest_mock; print('pytest-mock OK')"

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short -m "not slow"

      - name: Run tests with coverage
        if: matrix.python-version == '3.11'
        run: |
          pytest tests/ --cov=src --cov-report=xml --cov-report=term -m "not slow"

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pandas-stubs types-requests types-PyYAML

      - name: Run mypy
        run: mypy src/ --config-file=pyproject.toml
        continue-on-error: true  # Don't fail build on type errors for now

  integration:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Verify imports
        run: |
          python -c "from src import config; print('config OK')"
          python -c "from src.data_sources import AdminDataSourceRegistry; print('data_sources OK')"
          python -c "from src.benchmarks import get_ca_population; print('benchmarks OK')"
          python -c "from src.utils.analysis_units import get_estimand_spec; print('analysis_units OK')"
          python -c "from src.utils.bootstrap import BootstrapModelTrainer; print('bootstrap OK')"

      - name: Verify config integrity
        run: |
          python -c "
          from src import config
          # Verify SNAP weights are correct
          snap_hh = config.WELFARE_PROGRAMS['snap_household_householder']
          assert snap_hh['weight_col'] == 'WGTP', 'SNAP HH should use WGTP'

          snap_person = config.WELFARE_PROGRAMS['snap_person']
          assert snap_person['weight_col'] == 'PWGTP', 'SNAP person should use PWGTP'

          print('Config integrity check passed!')
          "
